<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Rob Young | digital</title>

  <meta charset="utf-8" lang="en">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/firacode/5.2.0/fira_code.min.css" integrity="sha512-MbysAYimH1hH2xYzkkMHB6MqxBqfP0megxsCLknbYqHVwXTCg9IqHbk+ZP/vnhO8UEW6PaXAkKe2vQ+SWACxxA==" crossorigin="anonymous" referrerpolicy="no-referrer">
  <link href="/style.css" rel="stylesheet">

  
</head>

<body>
  <header>
    <a class="site-header" href="/">Rob Young | <strong>digital</strong></a>

    <div class="filler"></div>

    <nav>
      <ul>
        <li class="here"><a href="/blog">posts</a></li>
      </ul>
    </nav>
  </header>

  <section class="content">
    
<h1>Create your own certificate authority with openssl - part two</h1>

<p><em>15 January 2020</em></p>

<p>In the <a href="/blog/ssl-certificate-authority-with-openssl/">previous post</a> we
set up certificate authority (CA), installed a CA certificate in our browser and
went through the process of signing and using some server certificates. In this
we'll create some client certificates to identify ourselves with our servers.
We'll then explore using these in a few different contexts; installing them in
our browser, using them with curl and also with <a href="http://www.dest-unreach.org/socat/">socat</a>.
As with the previous post, you can see it all tied together in this related
<a href="https://github.com/robyoung/nginx-client-certs">github repo</a>.</p>
<p>This post assumes you have the files generated in the <a href="/blog/ssl-certificate-authority-with-openssl/">previous post</a>.</p>
<table><thead><tr><th>File name</th><th>Use</th></tr></thead><tbody>
<tr><td><code>test-ca.key</code></td><td>private key for the CA</td></tr>
<tr><td><code>test-ca.pem</code></td><td>root certificate (CA)</td></tr>
<tr><td><code>test-server.key</code></td><td>private key for the server certificate</td></tr>
<tr><td><code>test-server-*-csr.pem</code></td><td>certificate signing requests for server</td></tr>
<tr><td><code>test-server-static-cert.pem</code></td><td>static server certificate</td></tr>
</tbody></table>
<h2 id="create-a-client-certificate">Create a client certificate</h2>
<p>Compared to creating a server certificate, which has lots of options, creating a client
certificate is pretty easy. First we create the private key. Note that if you want the
user to have to provide a password to use this client cert you just need to create a
passworded key and then use <code>passin</code> and <code>passout</code> when converting to PKCS later.</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span>&gt; openssl </span><span style="color:#bf616a;">genrsa -out</span><span> test-client.key 2048</span><span>
</span></code></pre>
<p>Then we create our certificate signing request. Our subject can be pretty empty for a client
cert.</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span>&gt; openssl </span><span style="color:#bf616a;">req -new</span><span> \</span><span>
</span><span>  </span><span style="color:#bf616a;">-subj </span><span>&quot;</span><span style="color:#a3be8c;">/C=GB</span><span>&quot; \</span><span>
</span><span>  </span><span style="color:#bf616a;">-key</span><span> test-client.key \</span><span>
</span><span>  </span><span style="color:#bf616a;">-out</span><span> test-client.csr</span><span>
</span></code></pre>
<p>Then we create our signed client certificate.</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span>&gt; openssl </span><span style="color:#bf616a;">x509</span><span> \</span><span>
</span><span>  </span><span style="color:#bf616a;">-req -in</span><span> test-client.csr \</span><span>
</span><span>  </span><span style="color:#bf616a;">-passin</span><span> pass:capassword \</span><span>
</span><span>  </span><span style="color:#bf616a;">-CA</span><span> test-ca.pem</span><span style="color:#bf616a;"> -CAkey</span><span> test-ca.key</span><span style="color:#bf616a;"> -CAcreateserial</span><span> \</span><span>
</span><span>  </span><span style="color:#bf616a;">-out</span><span> test-client.crt \</span><span>
</span><span>  </span><span style="color:#bf616a;">-days</span><span> 1825</span><span style="color:#bf616a;"> -sha256</span><span>
</span></code></pre>
<p>In order to use this client certificate in a browser we need to convert it to PKCS.</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span>&gt; openssl </span><span style="color:#bf616a;">pkcs12 -export -clcerts</span><span> \</span><span>
</span><span>  </span><span style="color:#bf616a;">-in</span><span> test-client.crt</span><span style="color:#bf616a;"> -inkey</span><span> test-client.key</span><span style="color:#bf616a;"> -out</span><span> test-client.p12</span><span>
</span></code></pre>
<p>The steps to install it in the browser depend on the browser you're using. For Firefox
you scroll right to the bottom of the Privacy &amp; Security tab of Preferences. Here click
on View Certificates then Your Certificates and finally Import your .p12 file.</p>
<p>Using the certificate with curl and socat is much simpler. We just need a combined PEM
including the key, certificate and CA certificate.</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span>&gt; cat </span><span style="color:#bf616a;">test-client.key</span><span> test-client.crt test-ca.pem &gt; test-client.pem</span><span>
</span></code></pre>
<p>Then this can then be used with curl</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span>&gt; curl </span><span style="color:#bf616a;">--cacert</span><span> test-ca.pem</span><span style="color:#bf616a;"> --cert</span><span> test-client.pem http://dev.test</span><span>
</span></code></pre>
<p>or with socat</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span>&gt; socat </span><span style="color:#bf616a;">\</span><span>
</span><span>  </span><span style="color:#bf616a;">tcp-listen:8096,fork,bind</span><span>=</span><span style="color:#a3be8c;">127.0.0.1 </span><span style="color:#bf616a;">\</span><span>
</span><span>  </span><span style="color:#bf616a;">openssl-connect:dev.test:443,cert</span><span>=</span><span style="color:#a3be8c;">test-client.pem,cafile=test-ca.pem</span><span>
</span></code></pre>
<h2 id="validating-the-client-certificate">Validating the client certificate</h2>
<p>So far we've created a client certificate and seen how we can use it to talk to
a server. In order to be useful though, this needs to be validated by the server.</p>
<p>Let us extend the <code>nginx.vhost.conf</code> from the previous post. The relevant
options are
<a href="https://nginx.org/en/docs/http/ngx_http_ssl_module.html#ssl_client_certificate"><code>ssl_client_certificate</code></a> or
<a href="https://nginx.org/en/docs/http/ngx_http_ssl_module.html#ssl_trusted_certificate"><code>ssl_trusted_certificate</code></a> and
<a href="https://nginx.org/en/docs/http/ngx_http_ssl_module.html#ssl_verify_client"><code>ssl_verify_client</code></a>.</p>
<p><code>nginx.vhost.conf</code></p>
<pre data-lang="nginx" style="background-color:#2b303b;color:#c0c5ce;" class="language-nginx "><code class="language-nginx" data-lang="nginx"><span>server {</span><span>
</span><span>  listen 443 ssl;</span><span>
</span><span>
</span><span>  server_name dev.test;</span><span>
</span><span>
</span><span>  ssl_client_certificate /etc/nginx/ssl/certs/test-ca.pem;</span><span>
</span><span>  ssl_verify_client on;</span><span>
</span><span>
</span><span>  ssl_certificate /etc/nginx/ssl/certs/server-crt.pem;</span><span>
</span><span>  ssl_certificate_key /etc/nginx/ssl/private/server.key;</span><span>
</span><span>
</span><span>  location / {</span><span>
</span><span>    return 200 &#39;Static vhost test\n&#39;;</span><span>
</span><span>    add_header Content-Type text/plain;</span><span>
</span><span>  }</span><span>
</span><span>}</span><span>
</span></code></pre>
<p>And here is the docker command to run it.</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span>&gt; docker </span><span style="color:#bf616a;">run</span><span> \</span><span>
</span><span>  </span><span style="color:#bf616a;">--rm -p</span><span> 443:443 \</span><span>
</span><span>  </span><span style="color:#bf616a;">-v </span><span>$(</span><span style="color:#bf616a;">pwd</span><span>)/nginx.vhost.conf:/etc/nginx/conf.d/default.conf:ro \</span><span>
</span><span>  </span><span style="color:#bf616a;">-v </span><span>$(</span><span style="color:#bf616a;">pwd</span><span>)/test-server.key:/etc/nginx/ssl/private/server.key:ro \</span><span>
</span><span>  </span><span style="color:#bf616a;">-v </span><span>$(</span><span style="color:#bf616a;">pwd</span><span>)/test-server-static-cert.pem:/etc/nginx/ssl/certs/server-crt.pem:ro \</span><span>
</span><span>  </span><span style="color:#bf616a;">-v </span><span>$(</span><span style="color:#bf616a;">pwd</span><span>)/test-ca.pem:/etc/nginx/ssl/certs/test-ca.pem:ro</span><span>
</span><span>  </span><span style="color:#bf616a;">nginx</span><span>
</span></code></pre>
<p>Now, if you still have all the configuration from the previous post,
we should be able to test it out.</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span>&gt; curl </span><span style="color:#bf616a;">--cacert</span><span> test-ca.pem</span><span style="color:#bf616a;"> --cert</span><span> test-client.pem http://dev.test</span><span>
</span><span style="color:#bf616a;">Static</span><span> vhost test</span><span>
</span></code></pre>
<p>or via <code>socat</code></p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span>&gt; curl </span><span style="color:#bf616a;">localhost:8096</span><span>
</span><span style="color:#bf616a;">Static</span><span> vhost test</span><span>
</span></code></pre>
<p>And we're all done!</p>


  </section>
</body>

</html>
